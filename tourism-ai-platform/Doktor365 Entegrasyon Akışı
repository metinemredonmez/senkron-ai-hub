## ğŸ§  Health Tourism AI Platform â€” Doktor365 Entegrasyon AkÄ±ÅŸÄ±

### ğŸ§© Genel Mimari AkÄ±ÅŸ

```
[Frontend / Mobile Dashboard]
        â”‚
        â–¼
[NestJS Backend]  â†”â†”  [Doktor365 API]
        â”‚                   â†‘
        â–¼                   â”‚
[AI Orchestrator (LangGraph FSM)] â†”â†” [Redis / Kafka / Qdrant / MinIO]
```

---

### 1ï¸âƒ£ Frontend & Mobile KatmanÄ±

* **KullanÄ±cÄ± arayÃ¼zÃ¼** (Next.js web dashboard ve React Native mobil uygulama).
* **AmacÄ±:** Hasta kayÄ±tlarÄ±, seyahat, uÃ§uÅŸ ve klinik iÅŸlemleri gÃ¶rselleÅŸtirmek.
* **BaÄŸlantÄ±:** TÃ¼m API Ã§aÄŸrÄ±larÄ±nÄ± `NestJS Backend` Ã¼zerinden gerÃ§ekleÅŸtirir.

  * `/api/cases`
  * `/api/external/d365/*`
  * `/api/ai/start-case`
* **Dashboard rolÃ¼:**

  * SaÄŸlÄ±k turizmine Ã¶zel metrikleri, doktor atamalarÄ±nÄ±, uÃ§uÅŸ detaylarÄ±nÄ± ve finansal sÃ¼reÃ§leri tek panelde sunar.
  * Backendâ€™ten gelen Doktor365 + Orchestrator verilerini birleÅŸtirerek gÃ¶sterir.

---

### 2ï¸âƒ£ Backend (NestJS Integration Layer)

* **Sistemin kalbi ve gateway katmanÄ±.**
* DÄ±ÅŸ sistemlerle (Doktor365, Amadeus, Stripe/Ä°yzico, WhatsApp) entegre olur.
* **Redis + Kafka** kullanarak:

  * Token cache (`d365:token:{tenant}`)
  * Idempotency key (`idem:{hash}`)
  * Rate limit & RBAC (tenant ve user bazlÄ± koruma)
* **Doktor365 Proxy UÃ§larÄ±:**

  * `/api/external/d365/deals/:id`
  * `/api/external/d365/deals/:id/notes`
  * `/api/external/d365/ai/send-flight-data`
  * `/api/ai/start-case`, `/api/ai/state/:caseId`, `/api/ai/resume-case`
* **RolÃ¼:** API Gateway gibi davranÄ±r; tÃ¼m istekleri kimlik, tenant ve token katmanlarÄ±ndan geÃ§irir.

---

### 3ï¸âƒ£ AI Orchestrator (FastAPI / LangGraph FSM)

* **AI karar motoru** (intake â†’ eligibility â†’ travel â†’ approval â†’ itinerary â†’ aftercare).
* Doktor365 entegrasyonu burada ÅŸu modÃ¼lde yapÄ±lÄ±r:

  * `tools/d365.py` â†’ `get_deal`, `add_note`, `send_flight_data` metodlarÄ±.
* FSM iÃ§inde her adÄ±mda bu fonksiyonlar Ã§aÄŸrÄ±lÄ±r ve Redisâ€™te `lg:ckpt:{caseId}` checkpoint kaydÄ± tutulur.
* **Kafka eventleri:**

  * `case.created`, `approval.required`, `travel.offer.generated`, `payment.succeeded`, `doc.uploaded`
* **AmaÃ§:** TÄ±bbi ve operasyonel karar zincirlerini otonom yÃ¶netmek.

---

### 4ï¸âƒ£ Doktor365 API (Harici CRM)

* **Roller:** Hasta / deal / appointment / uÃ§uÅŸ bilgilerini yÃ¶netir.
* **BaÅŸlÄ±ca UÃ§lar:**

  * `/patient/deals` â†’ Deal detaylarÄ±
  * `/patient/deals/note` â†’ Hasta notlarÄ±
  * `/patient/ai/send-flight-data` â†’ UÃ§uÅŸ bilgileri gÃ¶nderimi
* **Token:** `OAuth2` tabanlÄ±, backend Redis cache (â†’ `d365:token:{tenant}`) ile yÃ¶netilir.

---

### 5ï¸âƒ£ Dashboard (Senin Ã–zel GÃ¶rÃ¼nÃ¼m KatmanÄ±)

* **Hem web hem mobil versiyonu vardÄ±r.**
* **Veri kaynaÄŸÄ±:** Sadece senin backend (NestJS).
* **GÃ¶sterilenler:**

  * Hasta durumlarÄ±, AI karar aÅŸamalarÄ±, operasyon planlarÄ±, faturalama durumu, ve metrikler.
  * D365 Ã¼zerinden gelen datalar backend Redis veya DB'den Ã§ekilir.

---

### ğŸ”„ Veri AkÄ±ÅŸÄ± Ã–rneÄŸi (UÃ§uÅŸ Onay Senaryosu)

1. **Frontend** â†’ `POST /api/ai/start-case`
2. **Backend** â†’ `case.created` event â†’ Kafka
3. **Orchestrator FSM** â†’ `travel` node â†’ `send_flight_data()`
4. **tools/d365.py** â†’ Doktor365 `/patient/ai/send-flight-data`
5. **Doktor365** â†’ webhook (Ã¶r. `/webhooks/d365`)
6. **Backend** â†’ Redis + PostgreSQL gÃ¼ncellemesi
7. **Dashboard** â†’ `/api/cases/:id` endpoint ile yeni state'i gÃ¶sterir.

---

### ğŸ“Š Katman BazlÄ± Ã–zet

| Katman                     | AmaÃ§            | Doktor365 ile Ä°liÅŸkisi             |
| -------------------------- | --------------- | ---------------------------------- |
| **Frontend / Mobile**      | Dashboard & UI  | API Ã§aÄŸrÄ±larÄ±nÄ± backend'e yollar   |
| **Backend (NestJS)**       | Proxy + Gateway | Token cache + API proxy            |
| **Orchestrator (FastAPI)** | AI FSM          | D365 tool entegrasyonu             |
| **Doktor365**              | CRM             | Hasta / uÃ§uÅŸ / operasyon verileri  |
| **Dashboard (Senin)**      | GÃ¶rsel katman   | Backend'den gelen birleÅŸik datalar |

---

### ğŸ” Entegrasyonun AvantajlarÄ±

* KVKK / GDPR uyumlu, token cacheâ€™li, idempotent mimari.
* AI motoru (LangGraph FSM) ile otonom operasyon akÄ±ÅŸlarÄ±.
* TÃ¼m izleme Prometheus + Grafana + Loki + Tempo ile merkezi.
* D365 APIâ€™leri sadece backend tarafÄ±ndan Ã§aÄŸrÄ±ldÄ±ÄŸÄ± iÃ§in gÃ¼venli iletiÅŸim.

---

### ğŸŒ Ã–zetle

Bu sistemde **Doktor365 entegrasyonu** klasik anlamda bir â€œAPI Gatewayâ€ deÄŸil,
amaca yÃ¶nelik bir **Integration Layer + AI Orchestrator FSM** yapÄ±sÄ±dÄ±r.

* **NestJS Backend**: Doktor365 ile tÃ¼m dÄ±ÅŸ API iletiÅŸimini ve token yÃ¶netimini yapar.
* **Orchestrator FSM**: AI ajanlarÄ±n tÄ±bbi / operasyonel kararlarÄ±nÄ± otomatize eder.
* **Dashboard**: TÃ¼m veri ve metrikleri merkezi olarak sunar.
